name: Terraform CI/CD

on:
  push:
    branches:
      - main
      - master
      - dev
      - qa
      - prod
      - 'feature/*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - 'dev'
          - 'qa'
          - 'prod'
      aws_region:
        description: 'AWS Region'
        required: true
        type: string
        default: 'us-east-1'
      tf_state_bucket:
        description: 'Terraform State S3 Bucket'
        required: true
        type: string
      role_arn:
        description: 'AWS Role ARN (overrides default pipeline role)'
        required: false
        type: string
      fail_on_security_issues:
        description: 'Fail pipeline on security/linting issues'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  id-token: write   # Required for OIDC
  contents: read

jobs:
  terraform:
    name: Terraform Deploy
    runs-on: ubuntu-latest
    if: "!startsWith(github.ref_name, 'feature/') && contains(fromJson('[\"main\",\"master\",\"dev\",\"qa\",\"prod\"]'), github.ref_name)"
    environment: ${{ github.event.inputs.environment || github.ref_name }}

    env:
      AWS_REGION: ${{ github.event.inputs.aws_region || secrets.AWS_REGION }}
      TF_STATE_BUCKET: ${{ github.event.inputs.tf_state_bucket || secrets.TF_STATE_BUCKET }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set AWS Role and Environment
        id: set-role
        run: |
          # Determine environment from input or branch
          ENV="${{ github.event.inputs.environment }}"
          if [ -z "$ENV" ]; then
            BRANCH="${{ github.ref_name }}"
            case "$BRANCH" in
              main|master) ENV="prod" ;;
              qa) ENV="qa" ;;
              dev) ENV="dev" ;;
              *) ENV="dev" ;;
            esac
          fi
          echo "Environment: $ENV"
          
          # Use input role ARN or default pipeline role ARN
          if [ -n "${{ github.event.inputs.role_arn }}" ]; then
            ROLE_ARN="${{ github.event.inputs.role_arn }}"
            echo "Using input role ARN"
          else
            ROLE_ARN="${{ secrets.PIPELINE_ROLE_ARN }}"
            echo "Using pipeline role ARN"
          fi
          
          echo "ROLE_ARN=$ROLE_ARN" >> $GITHUB_ENV
          echo "ENVIRONMENT=$ENV" >> $GITHUB_ENV
          echo "Selected ROLE_ARN: $ROLE_ARN"
          echo "Selected ENVIRONMENT: $ENV"
          
          if [ -z "$ROLE_ARN" ] || [ "$ROLE_ARN" = "" ]; then
            echo "ERROR: No role ARN configured. Please set PIPELINE_ROLE_ARN secret or provide role_arn input."
            exit 1
          fi

      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ env.ROLE_ARN }}
          role-session-name: GitHubActions-${{ github.run_id }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.6.0

      - name: Terraform Init (S3 Backend)
        run: |
          terraform init \
            -backend-config="bucket=${{ env.TF_STATE_BUCKET }}" \
            -backend-config="key=${{ env.ENVIRONMENT }}/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -input=false

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@master
        continue-on-error: ${{ github.event.inputs.fail_on_security_issues != 'true' }}
        with:
          directory: .
          framework: terraform

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v3
        with:
          tflint_version: latest

      - name: Run TFLint
        continue-on-error: ${{ github.event.inputs.fail_on_security_issues != 'true' }}
        run: tflint --init && tflint

      - name: Run TFSec
        uses: aquasecurity/tfsec-action@v1.0.3
        continue-on-error: ${{ github.event.inputs.fail_on_security_issues != 'true' }}
        with:
          working_directory: .

      - name: Select .tfvars File
        run: |
          case "${{ env.ENVIRONMENT }}" in
            dev) echo "ENV_FILE=dev.tfvars" >> $GITHUB_ENV ;;
            qa) echo "ENV_FILE=qa.tfvars" >> $GITHUB_ENV ;;
            prod) echo "ENV_FILE=prod.tfvars" >> $GITHUB_ENV ;;
            *) echo "ENV_FILE=dev.tfvars" >> $GITHUB_ENV ;;
          esac

      - name: Terraform Plan
        run: terraform plan -var-file=${{ env.ENV_FILE }}

      - name: Terraform Apply
        if: env.ENVIRONMENT == 'prod'
        run: terraform apply -auto-approve -var-file=${{ env.ENV_FILE }}

  feature-branches:
    name: Feature Branch Plan
    runs-on: ubuntu-latest
    if: startsWith(github.ref_name, 'feature/')
    env:
      AWS_REGION: ${{ github.event.inputs.aws_region || secrets.AWS_REGION }}
      TF_STATE_BUCKET: ${{ github.event.inputs.tf_state_bucket || secrets.TF_STATE_BUCKET }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set Role ARN for Feature Branch
        run: |
          if [ -n "${{ github.event.inputs.role_arn }}" ]; then
            ROLE_ARN="${{ github.event.inputs.role_arn }}"
            echo "Using input role ARN"
          else
            ROLE_ARN="${{ secrets.PIPELINE_ROLE_ARN }}"
            echo "Using pipeline role ARN"
          fi
          echo "ROLE_ARN=$ROLE_ARN" >> $GITHUB_ENV
          echo "Selected ROLE_ARN: $ROLE_ARN"
          if [ -z "$ROLE_ARN" ]; then
            echo "ERROR: No role ARN configured. Please set PIPELINE_ROLE_ARN secret or provide role_arn input."
            exit 1
          fi

      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ env.ROLE_ARN }}
          role-session-name: GitHubActions-${{ github.run_id }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.6.0

      - name: Terraform Init (S3 Backend)
        run: |
          terraform init \
            -backend-config="bucket=${{ env.TF_STATE_BUCKET }}" \
            -backend-config="key=feature/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -input=false

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@master
        continue-on-error: ${{ github.event.inputs.fail_on_security_issues != 'true' }}
        with:
          directory: .
          framework: terraform

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v3
        with:
          tflint_version: latest

      - name: Run TFLint
        continue-on-error: ${{ github.event.inputs.fail_on_security_issues != 'true' }}
        run: tflint --init && tflint

      - name: Run TFSec
        uses: aquasecurity/tfsec-action@v1.0.3
        continue-on-error: ${{ github.event.inputs.fail_on_security_issues != 'true' }}
        with:
          working_directory: .

      - name: Select .tfvars File (Feature Branch)
        run: |
          TFVARS_FILE=$(ls *.tfvars | head -1)
          echo "ENV_FILE=$TFVARS_FILE" >> $GITHUB_ENV

      - name: Terraform Plan (Feature Branch)
        run: terraform plan -var-file=${{ env.ENV_FILE }}